<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HaRi√© CMS ‚Äì Debug Mode</title>

    <style>
      body {
        font-family: monospace;
        padding: 2rem;
        background: #0d1117;
        color: #c9d1d9;
      }
      h3 {
        color: #58a6ff;
      }
      #log {
        white-space: pre-wrap;
        background: #161b22;
        color: #00ff80;
        padding: 1rem;
        border-radius: 8px;
        overflow-y: auto;
        max-height: 80vh;
        border: 1px solid #30363d;
      }
      .error {
        color: #ff5555;
      }
      .warn {
        color: #ffaa00;
      }
      .success {
        color: #00ff80;
      }
    </style>

    <!-- Load Decap CMS (formerly Netlify CMS) -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    <script src="https://unpkg.com/js-yaml@4.1.0/dist/js-yaml.min.js"></script>

    <script>
      window.CMS_MANUAL_INIT = true;

      const logBox = () => document.getElementById("log");
      const log = (msg, type = "info") => {
        const entry = document.createElement("div");
        entry.className = type;
        entry.textContent = msg;
        logBox().appendChild(entry);
        console[type === "error" ? "error" : type === "warn" ? "warn" : "log"](
          msg
        );
      };

      // Wait for everything to load
      window.addEventListener("load", async () => {
        log("üìò CMS page loaded, starting extended debug...");

        // Check what's available - try both old and new names
        log(`üì¶ window.jsyaml available: ${!!window.jsyaml}`);
        log(`üì¶ window.DecapCmsApp available: ${!!window.DecapCmsApp}`);
        log(`üì¶ window.CMS available: ${!!window.CMS}`);
        log(`üì¶ window.netlifyCms available: ${!!window.netlifyCms}`);
        log(`üì¶ window.decapCms available: ${!!window.decapCms}`);

        // Try all possible CMS objects
        let cms =
          window.DecapCmsApp ||
          window.CMS ||
          window.netlifyCms ||
          window.decapCms;

        if (!cms) {
          log("‚ùå No CMS object found. Available global objects:", "error");
          // List all global objects that might be related
          Object.keys(window).forEach((key) => {
            if (
              key.toLowerCase().includes("cms") ||
              key.toLowerCase().includes("netlify") ||
              key.toLowerCase().includes("decap")
            ) {
              log(`   - ${key}: ${typeof window[key]}`);
            }
          });
          return;
        }

        log(`‚úÖ Using CMS object: ${cms.constructor.name}`, "success");

        const configPath = "admin/config.yml";
        log(`üåê Fetching config from: ${window.location.origin}/${configPath}`);

        try {
          const res = await fetch(configPath);
          log(`üì° Response status ‚Üí ${res.status}`);
          log(`üìÑ Content-Type ‚Üí ${res.headers.get("content-type")}`);

          if (!res.ok) {
            log(`‚ùå Config fetch failed with status: ${res.status}`, "error");
            log("üí° Make sure config.yml exists in /admin/ folder", "warn");
            return;
          }

          const text = await res.text();
          log("üßæ YAML preview (first 300 chars):\n" + text.slice(0, 300));

          if (!window.jsyaml) {
            log("‚ö†Ô∏è js-yaml library not loaded properly!", "warn");
            return;
          }

          let config;
          try {
            config = window.jsyaml.load(text);
            log("‚úÖ YAML parsed successfully", "success");
          } catch (parseErr) {
            log(`‚ùå YAML parse error: ${parseErr.message}`, "error");
            return;
          }

          if (!config || !config.backend) {
            log(
              "‚ö†Ô∏è Parsed config is missing 'backend' or top-level keys.",
              "warn"
            );
          } else {
            log("‚úÖ Parsed config keys: " + Object.keys(config).join(", "));
            log(`‚úÖ Backend type: ${config.backend.name}`);
          }

          // Initialize CMS
          try {
            cms.init({ config });
            log("üéâ CMS initialized successfully!", "success");
          } catch (cmsErr) {
            log("‚ùå CMS initialization failed: " + cmsErr.message, "error");
          }
        } catch (err) {
          log("üî• Fatal CMS load error: " + err.message, "error");
        }
      });
    </script>
  </head>

  <body>
    <h3>üß© HaRi√© CMS Debug Console</h3>
    <div id="log">Loading...</div>
  </body>
</html>
